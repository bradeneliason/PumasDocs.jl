<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Estimating Parameters of Pumas Models · PuMaS</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>PuMaS</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../">Home</a></li><li><span class="toctext">Tutorials</span><ul><li><a class="toctext" href="../../tutorials/introduction/">Introduction to Pumas</a></li></ul></li><li><span class="toctext">Basics</span><ul><li><a class="toctext" href="../overview/">Overview of Pumas</a></li><li><a class="toctext" href="../models/">Defining NLME Models</a></li><li><a class="toctext" href="../doses_subjects_populations/">Dosage Regimens, Subjects, and Populations</a></li><li><a class="toctext" href="../simulation/">Simulation of Pumas Models</a></li><li class="current"><a class="toctext" href>Estimating Parameters of Pumas Models</a><ul class="internal"><li><a class="toctext" href="#Defining-Data-for-Estimation-1">Defining Data for Estimation</a></li><li><a class="toctext" href="#Maximum-Likelihood-Estimation-1">Maximum Likelihood Estimation</a></li><li><a class="toctext" href="#Bayesian-Estimation-1">Bayesian Estimation</a></li></ul></li><li><a class="toctext" href="../nca/">Noncompartmental Analysis (NCA)</a></li><li><a class="toctext" href="../faq/">Frequently Asked Questions (FAQ)</a></li></ul></li><li><span class="toctext">Model Components</span><ul><li><a class="toctext" href="../../model_components/domains/">Domains</a></li><li><a class="toctext" href="../../model_components/dosing_control/">Dosing Control Parameters (DCP)</a></li><li><a class="toctext" href="../../model_components/dynamical_types/">Dynamical Problem Types</a></li></ul></li><li><span class="toctext">Diagnostics</span><ul><li><a class="toctext" href="../../analysis/diagnostics/">Simulation and Estimation Diagnostics</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li>Basics</li><li><a href>Estimating Parameters of Pumas Models</a></li></ul><a class="edit-page" href="https://github.com/PumasAI/PumasDocs.jl/blob/master/docs/src/basics/estimation.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Estimating Parameters of Pumas Models</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Estimating-Parameters-of-Pumas-Models-1" href="#Estimating-Parameters-of-Pumas-Models-1">Estimating Parameters of Pumas Models</a></h1><p>Pumas can use the observational data of a <code>Subject</code> or <code>Population</code> to estimate the parameters of an NLME model. This is done by two classes of methods. Maximum likelihood methods find the parameters such that the observational data has the highest probability of occurring according to the chosen error distributions. Bayesian methods find a posterior probability distribution for the parameters to describe the chance that a parameter has a given value given the data. The following section describes how to fit an NLME model in Pumas via the two methods.</p><h2><a class="nav-anchor" id="Defining-Data-for-Estimation-1" href="#Defining-Data-for-Estimation-1">Defining Data for Estimation</a></h2><p>Estimation is done by looking at the likelihood of likewise names. Thus, for example if <code>subject.observations</code> is a <code>NamedTuple</code> with names <code>dv</code> and <code>resp</code>, the likelihood calculation will be between values from <code>derived</code> named <code>dv</code> and <code>resp</code>. If <code>dv</code> is a scalar in the observation data, then <code>dv</code> from <code>derived</code> should also be a scalar. Likewise, if <code>dv</code> is an array like a time series, then <code>dv</code> should be a size-matching time series when returned from <code>derived</code>. Note that likelihoods are calculated between the probability distribution from <code>derived</code> and the matching observation from <code>subject.observations</code>. If no likelihood is associated with a <code>derived</code> value, then the value has an implicit standard normal interpretation, which amounts to having the L2 Euclidian distance taken as the likelihood during fitting procedures.</p><p><strong>Note: Currently only <code>BayesMCMC</code> and <code>LaplaceI</code> support multiple output series. all other likelihood approximations must have the derived and observation data under the name <code>dv</code></strong></p><p><strong>Note: Currently the estimation procedures require that there only exists a single random effect (vector), and this vector must be named η (\eta)</strong></p><h2><a class="nav-anchor" id="Maximum-Likelihood-Estimation-1" href="#Maximum-Likelihood-Estimation-1">Maximum Likelihood Estimation</a></h2><p>Maximum Likelihood Estimation (MLE) is performed using the <code>fit</code> function. This function&#39;s signature is:</p><pre><code class="language-julia">Distributions.fit(m::PumasModel,
                  data::Population,
                  param::NamedTuple,
                  approx::LikelihoodApproximation,
                  args...;
                  optimize_fn = DEFAULT_OPTIMIZE_FN,
                  kwargs...)</code></pre><p>The arguments are:</p><ul><li><code>m</code>: a <code>PumasModel</code>, either defined by the <code>@model</code> DSL or the function-based interface.</li><li><code>data</code>: a <code>Population</code>.</li><li><code>param</code>: a named tuple of parameters. Used as the initial condition for the optimizer.</li><li><code>approx</code>: the marginal loglikelihood approximation to use for the maximum likelihood procedure.</li><li>Extra <code>args</code> and <code>kwargs</code> are passed on to the internal <code>simobs</code> call and thus control the behavior of the differential equation solvers.</li><li><code>optimize_fn</code>: a function of two arguments <code>(cost,p)</code> where <code>cost</code> is the cost function and <code>p</code> is the initial parameters as a vector. This function defines the optimization routine that is used to find the maximum of the likelihood. The default optimization function uses the <a href="http://julianlsolvers.github.io/Optim.jl/stable/">Optim.jl</a> library and is defined as follows:</li></ul><pre><code class="language-julia">function DEFAULT_OPTIMIZE_FN(cost,p)
  Optim.optimize(cost,p,BFGS(linesearch=Optim.LineSearches.BackTracking()),
                 Optim.Options(show_trace=verbose, # Print progress
                               store_trace=true,
                               extended_trace=true,
                               g_tol=1e-3),
                  autodiff=:finite)
end</code></pre><p>The return type of <code>fit</code> is a <code>FittedPumasModel</code>.</p><h3><a class="nav-anchor" id="Marginal-Likelihood-Approximations-1" href="#Marginal-Likelihood-Approximations-1">Marginal Likelihood Approximations</a></h3><p>The following choices are available for the likelihood approximations:</p><ul><li><code>FO()</code>: first order approximation.</li><li><code>FOI()</code>: first order approximation with interaction. Not complete.</li><li><code>FOCE()</code>: first order conditional estimation.</li><li><code>FOCEI()</code>: first order conditional estimation with interaction.</li><li><code>Laplace()</code>: second order Laplace approximation</li><li><code>LaplaceI()</code>: second order Laplace approximation with interaction.</li></ul><h3><a class="nav-anchor" id="FittedPumasModel-1" href="#FittedPumasModel-1">FittedPumasModel</a></h3><p>The relevant fields of a <code>FittedPumasModel</code> are:</p><ul><li><code>model</code>: the <code>model</code> used in the estimation process.</li><li><code>data</code>: the <code>Population</code> that was estimated.</li><li><code>approx</code>: the marginal likelihood approximation that was used.</li><li><code>param</code>: the optimal parameters.</li></ul><p>Additionally, the following functions help interpret the fit:</p><ul><li><code>vcov(fpm)</code> returns the covariance matrix between the population parameters for the <code>FittedPumasModel</code></li><li><code>stderror(fpm)</code> returns the standard errors for the population parameters for the <code>FittedPumasModel</code></li></ul><p>Additionally the function:</p><pre><code class="language-julia">predict(fpm::FittedPumasModel, approx=fpm.approx;
        nsim=nothing, timegrid=false, newdata=false, useEBEs=true)</code></pre><p>Returns a <code>FittedPumasPrediction</code> which contains the solution of all population diagnostics in the field <code>population</code> and all individual diagnostics in the field <code>individual</code>. For more information on the diagnostics, please see the <a href="../../analysis/diagnostics/#Simulation-and-Estimation-Diagnostics-1">Simulation and Estimation Diagnostics</a></p><h2><a class="nav-anchor" id="Bayesian-Estimation-1" href="#Bayesian-Estimation-1">Bayesian Estimation</a></h2><p>Bayesian parameter estimation is performed by using the <code>fit</code> function as follows:</p><pre><code class="language-julia">fit(model::PumasModel, data::Population, ::BayesMCMC,
                       args...; nsamples=5000, kwargs...)</code></pre><p>The arguments are:</p><ul><li><code>m</code>: a <code>PumasModel</code>, either defined by the <code>@model</code> DSL or the function-based interface.</li><li><code>data</code>: a <code>Population</code>.</li><li>The <code>approx</code> must be <code>BayesMCMC()</code>.</li><li><code>nsamples</code> determines the number of samples taken along each chain.</li><li>Extra <code>args</code> and <code>kwargs</code> are passed on to the internal <code>simobs</code> call and thus control the behavior of the differential equation solvers.</li></ul><p>The result is a <code>BayesMCMCResults</code> type. Notice that initial parameter values are not utilized in Bayesian estimation.</p><h3><a class="nav-anchor" id="BayesMCMCResults-1" href="#BayesMCMCResults-1">BayesMCMCResults</a></h3><p>The MCMC chain is stored in the <code>chain</code> field of the returned <code>BayesMCMCResults</code>. The following functions help with querying common results on the Bayesian posterior:</p><ul><li><code>param_mean(br)</code>: returns a named tuple of parameters which represents the mean of each parameter&#39;s posterior distribution</li><li><code>param_var(br)</code>: returns a named tuple of parameters which represents the variance of each parameter&#39;s posterior distribution</li><li><code>param_std(br)</code>: returns a named tuple of parameters which represents the standard deviation of each parameter&#39;s posterior distribution</li></ul><footer><hr/><a class="previous" href="../simulation/"><span class="direction">Previous</span><span class="title">Simulation of Pumas Models</span></a><a class="next" href="../nca/"><span class="direction">Next</span><span class="title">Noncompartmental Analysis (NCA)</span></a></footer></article></body></html>
