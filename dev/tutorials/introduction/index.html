<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Introduction to Pumas · Pumas</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><a href="../../index.html"><img class="logo" src="../../assets/logo.png" alt="Pumas logo"/></a><h1>Pumas</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../">Home</a></li><li><span class="toctext">Tutorials</span><ul><li class="current"><a class="toctext" href>Introduction to Pumas</a><ul class="internal"><li><a class="toctext" href="#Working-Example-1">Working Example</a></li><li><a class="toctext" href="#Using-the-Model-Macro-1">Using the Model Macro</a></li><li><a class="toctext" href="#Building-a-Subject-1">Building a Subject</a></li><li><a class="toctext" href="#Running-a-Simulation-1">Running a Simulation</a></li><li><a class="toctext" href="#Handling-the-SimulatedObservations-1">Handling the SimulatedObservations</a></li><li><a class="toctext" href="#Conclusion-1">Conclusion</a></li></ul></li></ul></li><li><span class="toctext">Basics</span><ul><li><a class="toctext" href="../../basics/overview/">Overview of Pumas</a></li><li><a class="toctext" href="../../basics/models/">Defining NLME Models</a></li><li><a class="toctext" href="../../basics/doses_subjects_populations/">Dosage Regimens, Subjects, and Populations</a></li><li><a class="toctext" href="../../basics/simulation/">Simulation of Pumas Models</a></li><li><a class="toctext" href="../../basics/estimation/">Estimating Parameters of Pumas Models</a></li><li><a class="toctext" href="../../basics/nca/">Noncompartmental Analysis (NCA)</a></li><li><a class="toctext" href="../../basics/faq/">Frequently Asked Questions (FAQ)</a></li></ul></li><li><span class="toctext">Model Components</span><ul><li><a class="toctext" href="../../model_components/domains/">Domains</a></li><li><a class="toctext" href="../../model_components/dosing_control/">Dosing Control Parameters (DCP)</a></li><li><a class="toctext" href="../../model_components/dynamical_types/">Dynamical Problem Types</a></li></ul></li><li><span class="toctext">Diagnostics</span><ul><li><a class="toctext" href="../../analysis/diagnostics/">Simulation and Estimation Diagnostics</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li>Tutorials</li><li><a href>Introduction to Pumas</a></li></ul><a class="edit-page" href="https://github.com/PumasAI/PumasDocs.jl/blob/master/docs/src/tutorials/introduction.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Introduction to Pumas</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Introduction-to-Pumas-1" href="#Introduction-to-Pumas-1">Introduction to Pumas</a></h1><p>This is an introduction to Pumas, a software for pharmaceutical modeling and simulation.</p><p>The basic workflow of Pumas is:</p><ol><li>Build a model.</li><li>Define subjects or populations to simulate or estimate.</li><li>Analyze the results with post-processing and plots.</li></ol><p>We will show how to build a multiple-response PK/PD model via the <code>@model</code> macro, define a subject with multiple doses, and analyze the results of the simulation. This tutorial is made to be a broad overview of the workflow and more in-depth treatment of each section can be found in the subsequent tutorials and documentation.</p><h2><a class="nav-anchor" id="Working-Example-1" href="#Working-Example-1">Working Example</a></h2><p>Let&#39;s start by showing a complete simulation code, and then break down how it works.</p><pre><code class="language-julia">using Pumas, LinearAlgebra

model = @model begin

    @param begin
      θ ∈ VectorDomain(12)
    end

    @random begin
      η ~ MvNormal(Matrix{Float64}(I, 11, 11))
    end

    @pre begin
        Ka     = θ[1]
        CL      = θ[2]*exp(η[1])
        Vc      = θ[3]*exp(η[2])
        Q       = θ[4]*exp(η[3])
        Vp      = θ[5]*exp(η[4])
        Kin     = θ[6]*exp(η[5])
        Kout    = θ[7]*exp(η[6])
        IC50    = θ[8]*exp(η[7])
        IMAX    = θ[9]*exp(η[8])
        γ       = θ[10]*exp(η[9])
        Vmax    = θ[11]*exp(η[10])
        Km      = θ[12]*exp(η[11])
    end

    @init begin
        Resp = Kin/Kout
    end

    @dynamics begin
        Depot&#39;  = -Ka*Depot
        Cent&#39;   =  Ka*Depot - (CL+Vmax/(Km+(Cent/Vc))+Q)*(Cent/Vc)  + Q*(Periph/Vp)
        Periph&#39; =  Q*(Cent/Vc)  - Q*(Periph/Vp)
        Resp&#39;   =  Kin*(1-(IMAX*(Cent/Vc)^γ/(IC50^γ+(Cent/Vc)^γ)))  - Kout*Resp
    end

    @derived begin
        depot    = Depot
        cp     = Cent / Vc
        periph = Periph
        resp   = Resp
    end
end

regimen = DosageRegimen([15,15,15,15], time=[0,4,8,12])
subject = Subject(id=1,evs=regimen)

param = (θ = [
              1, # Ka  Absorption rate constant 1 (1/time)
              1, # CL   Clearance (volume/time)
              20, # Vc   Central volume (volume)
              2, # Q    Inter-compartmental clearance (volume/time)
              10, # Vp   Peripheral volume of distribution (volume)
              10, # Kin  Response in rate constant (1/time)
              2, # Kout Response out rate constant (1/time)
              2, # IC50 Concentration for 50% of max inhibition (mass/volume)
              1, # IMAX Maximum inhibition
              1, # γ    Emax model sigmoidicity
              0, # Vmax Maximum reaction velocity (mass/time)
              2  # Km   Michaelis constant (mass/volume)
              ],) # single element `NamedTuple`s end with a comma

sim = simobs(model, subject, param)

using Plots
plot(sim)</code></pre><p><img src="https://user-images.githubusercontent.com/1814174/61486825-5d686780-a972-11e9-958e-dbb95e410267.png" alt="Plot sim"/></p><p>In this code, we defined a nonlinear mixed effects model by describing the parameters, the random effects, the dynamical model, and the derived (result) values. Then we generated a subject who receives doses of 15mg every 4 hours, specified parameter values, simulated the model, and generated a plot of the results. Now let&#39;s walk through this process!</p><h2><a class="nav-anchor" id="Using-the-Model-Macro-1" href="#Using-the-Model-Macro-1">Using the Model Macro</a></h2><p>First we define the model. The simplest way to do is via the <code>@model</code> DSL. Inside of this block we have a few subsections. The first of which is <code>@param</code>. In here we define what kind of parameters we have. For this model we will define a vector parameter <code>θ</code> of size 12:</p><pre><code class="language-julia">@param begin
  θ ∈ VectorDomain(12)
end</code></pre><p>Next we define our random effects. The random effects are defined by a distribution from Distributions.jl. For more information on defining distributions, please see the Distributions.jl documentation. For this tutorial, we wish to have a multivariate normal of 11 uncorrelated random effects, so we utilize the syntax:</p><pre><code class="language-julia">using LinearAlgebra
@random begin
  η ~ MvNormal(Matrix{Float64}(I, 11, 11))
end</code></pre><p>Notice that here we imported <code>I</code> from LinearAlgebra and said that our Normal distribution&#39;s covariance is said <code>I</code>, the identity matrix.</p><p>Now we define our pre-processing step in <code>@pre</code>. This is where we choose how the parameters, random effects, and the covariates collate. We define the values and give them a name as follows:</p><pre><code class="language-julia">@pre begin
    Ka1     = θ[1]
    CL      = θ[2]*exp(η[1])
    Vc      = θ[3]*exp(η[2])
    Q       = θ[4]*exp(η[3])
    Vp      = θ[5]*exp(η[4])
    Kin     = θ[6]*exp(η[5])
    Kout    = θ[7]*exp(η[6])
    IC50    = θ[8]*exp(η[7])
    IMAX    = θ[9]*exp(η[8])
    γ       = θ[10]*exp(η[9])
    Vmax    = θ[11]*exp(η[10])
    Km      = θ[12]*exp(η[11])
end</code></pre><p>Next we define the <code>@init</code> block which gives the initial values for our differential equations. Any variable not mentioned in this block is assumed to have a zero for its starting value. We wish to only set the starting value for <code>Resp</code>, and thus we use:</p><pre><code class="language-julia">@init begin
    Resp = Kin/Kout
end</code></pre><p>Now we define our dynamics. We do this via the <code>@dynamics</code> block. Differential variables are declared by having a line defining their derivative. For our model, we use:</p><pre><code class="language-julia">@dynamics begin
    Depot&#39;  = -Ka*Depot
    Cent&#39;   =  Ka*Depot - (CL+Vmax/(Km+(Cent/Vc))+Q)*(Cent/Vc)  + Q*(Periph/Vp)
    Periph&#39; =  Q*(Cent/Vc)  - Q*(Periph/Vp)
    Resp&#39;   =  Kin*(1-(IMAX*(Cent/Vc)^γ/(IC50^γ+(Cent/Vc)^γ)))  - Kout*Resp
end</code></pre><p>Lastly we utilize the <code>@derived</code> macro to define our post-processing. We can output values using the following:</p><pre><code class="language-julia">@derived begin
    depot  = Depot
    cp     = Cent / θ[3]
    periph = Periph
    resp   = Resp
end</code></pre><h2><a class="nav-anchor" id="Building-a-Subject-1" href="#Building-a-Subject-1">Building a Subject</a></h2><p>Now let&#39;s build a subject to simulate the model with. A subject defines three components:</p><ol><li>The dosage regimen</li><li>The covariates of the individual</li><li>Observations associated with the individual.</li></ol><p>Our model did not make use of covariates so we will ignore (2) for now, and (3) is only necessary for fitting parameters to data which will not be covered in this tutorial. Thus our subject will be defined simply by its dosage regimen.</p><p>To do this, we use the <code>DosageRegimen</code> constructor. It uses terms from the NMTRAN format to specify its dose schedule. The first value is always the dosing amount. Then there are optional arguments, the most important of which is <code>time</code> which specifies the time that the dosing occurs. For example,</p><pre><code class="language-julia">DosageRegimen(15, time=0)</code></pre><p>is a dosage regimen which simply does a single dose at time <code>t=0</code> of amount 15. If we use arrays, then the dosage regimen will be the grouping of the values. For example, let&#39;s define a dose of amount 15 at times <code>t=0,4,8</code>, and <code>12</code>:</p><pre><code class="language-julia">regimen = DosageRegimen([15,15,15,15], time=[0,4,8,12])</code></pre><p>Let&#39;s define our subject to have <code>id=1</code> and this multiple dosing regimen:</p><pre><code class="language-julia">subject = Subject(id=1,evs=regimen)</code></pre><h2><a class="nav-anchor" id="Running-a-Simulation-1" href="#Running-a-Simulation-1">Running a Simulation</a></h2><p>The main function for running a simulation is <code>simobs</code>. <code>simobs</code> on a population simulates all of the population (in parallel), while <code>simobs</code> on a subject simulates just that subject. If we wish to change the parameters from the initialized values, then we pass them in. Let&#39;s simulate subject 1 with a set of chosen parameters:</p><pre><code class="language-julia">param = (θ = [
          1, # Ka  Absorption rate constant 1 (1/time)
          1, # CL   Clearance (volume/time)
          20, # Vc   Central volume (volume)
          2, # Q    Inter-compartmental clearance (volume/time)
          10, # Vp   Peripheral volume of distribution (volume)
          10, # Kin  Response in rate constant (1/time)
          2, # Kout Response out rate constant (1/time)
          2, # IC50 Concentration for 50% of max inhibition (mass/volume)
          1, # IMAX Maximum inhibition
          1, # γ    Emax model sigmoidicity
          0, # Vmax Maximum reaction velocity (mass/time)
          2  # Km   Michaelis constant (mass/volume)
          ],)

sim = simobs(model, subject, param)</code></pre><p>We can then plot the simulated observations by using the <code>plot</code> command:</p><pre><code class="language-julia">using Plots
plot(sim)</code></pre><p><img src="https://user-images.githubusercontent.com/1814174/61486825-5d686780-a972-11e9-958e-dbb95e410267.png" alt="show plot"/></p><p>Note that we can use the <a href="http://docs.juliaplots.org/latest/attributes/">attributes from <code>Plots.jl</code></a> to further modify the plot. For example,</p><pre><code class="language-julia">plot(sim,
     color=2,thickness_scaling=1.5,
     legend=false, lw=2)</code></pre><p><img src="https://user-images.githubusercontent.com/1814174/61486892-90126000-a972-11e9-96ef-e898dc2a9dc7.png" alt="show plot"/></p><p>Notice that in our model we said that there was a single parameter <code>θ</code> so our input parameter is a named tuple with just the name <code>θ</code>. When we only give the parameters, the random effects are automatically sampled from their distributions. If we wish to prescribe a value for the random effects, we pass initial values similarly:</p><pre><code class="language-julia">randeffs = (η = rand(11),)
sim = simobs(model, subject, param, randeffs)
plot(sim)</code></pre><p><img src="https://user-images.githubusercontent.com/1814174/61487094-031bd680-a973-11e9-9835-4ad1c52a87ba.png" alt="show plot"/></p><p>If a population simulation is required with no random effects, then the values of the η&#39;s can be set to zero that will result in a simulation only at the mean level:</p><pre><code class="language-julia">randeffs = (η = zeros(11),)
sim = simobs(model, subject, param, randeffs)
plot(sim)</code></pre><p><img src="https://user-images.githubusercontent.com/1814174/61487172-30688480-a973-11e9-8292-a3a7764986bc.png" alt="show plot"/></p><p>The points which are saved are by default at once every hour until one day after the last event. If you wish to change the saving time points, pass the keyword argument <code>obstimes</code>. For example, let&#39;s save at every <code>0.1</code> hours and run the simulation for 19 hours:</p><pre><code class="language-julia">sim = simobs(model, subject, param, randeffs, obstimes = 0:0.1:19)</code></pre><h2><a class="nav-anchor" id="Handling-the-SimulatedObservations-1" href="#Handling-the-SimulatedObservations-1">Handling the SimulatedObservations</a></h2><p>The resulting <code>SimulatedObservations</code> type has two fields. <code>sim.times</code> is an array of time points for which the data was saved. <code>sim.derived</code> is the result of the derived variables. From there, the derived variables are accessed by name. For example,</p><pre><code class="language-julia">sim[:cp]</code></pre><p>is the array of <code>cp</code> values at the associated time points. We can turn this into a DataFrame via using the <code>DataFrame</code> command:</p><pre><code class="language-julia">DataFrame(sim)</code></pre><p>From there, any Julia tools can be used to analyze these arrays and DataFrames. For example, if we wish the plot the result of <code>depot</code> over time, we&#39;d use the following:</p><pre><code class="language-julia">plot(sim.times,sim[:depot])</code></pre><p>Using these commands, a Julia program can be written to post-process the program however you like!</p><h2><a class="nav-anchor" id="Conclusion-1" href="#Conclusion-1">Conclusion</a></h2><p>This tutorial covered basic workflow for how to build a model and simulate results from it. The subsequent tutorials will go into more detail in the components, such as:</p><ol><li>More detailed treatment of specifying populations, dosage regimens, and covariates.</li><li>Reading in dosage regimens and observations from NMTRAN data.</li></ol><footer><hr/><a class="previous" href="../../"><span class="direction">Previous</span><span class="title">Home</span></a><a class="next" href="../../basics/overview/"><span class="direction">Next</span><span class="title">Overview of Pumas</span></a></footer></article></body></html>
