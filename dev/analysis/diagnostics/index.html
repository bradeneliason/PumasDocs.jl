<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Simulation and Estimation Diagnostics · PuMaS</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>PuMaS</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../">Home</a></li><li><span class="toctext">Tutorials</span><ul><li><a class="toctext" href="../../tutorials/introduction/">Introduction to Pumas</a></li></ul></li><li><span class="toctext">Basics</span><ul><li><a class="toctext" href="../../basics/overview/">Overview of Pumas</a></li><li><a class="toctext" href="../../basics/models/">Defining NLME Models</a></li><li><a class="toctext" href="../../basics/doses_subjects_populations/">Dosage Regimens, Subjects, and Populations</a></li><li><a class="toctext" href="../../basics/simulation/">Simulation of Pumas Models</a></li><li><a class="toctext" href="../../basics/estimation/">Estimating Parameters of Pumas Models</a></li><li><a class="toctext" href="../../basics/nca/">Noncompartmental Analysis (NCA)</a></li><li><a class="toctext" href="../../basics/faq/">Frequently Asked Questions (FAQ)</a></li></ul></li><li><span class="toctext">Model Components</span><ul><li><a class="toctext" href="../../model_components/domains/">Domains</a></li><li><a class="toctext" href="../../model_components/dosing_control/">Dosing Control Parameters (DCP)</a></li><li><a class="toctext" href="../../model_components/dynamical_types/">Dynamical Problem Types</a></li></ul></li><li><span class="toctext">Diagnostics</span><ul><li class="current"><a class="toctext" href>Simulation and Estimation Diagnostics</a><ul class="internal"><li><a class="toctext" href="#The-infer-Function-1">The <code>infer</code> Function</a></li><li><a class="toctext" href="#The-inspect-Function-1">The <code>inspect</code> Function</a></li><li><a class="toctext" href="#Model-Diagnostic-Functions-1">Model Diagnostic Functions</a></li><li><a class="toctext" href="#The-Visual-Predictive-Check-(vpc)-Function-1">The Visual Predictive Check (<code>vpc</code>) Function</a></li></ul></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li>Diagnostics</li><li><a href>Simulation and Estimation Diagnostics</a></li></ul><a class="edit-page" href="https://github.com/PumasAI/PumasDocs.jl/blob/master/docs/src/analysis/diagnostics.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Simulation and Estimation Diagnostics</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Simulation-and-Estimation-Diagnostics-1" href="#Simulation-and-Estimation-Diagnostics-1">Simulation and Estimation Diagnostics</a></h1><h2><a class="nav-anchor" id="The-infer-Function-1" href="#The-infer-Function-1">The <code>infer</code> Function</a></h2><p><code>infer(fpm::FittedPumasModel)</code> </p><p><code>infer</code> computes the <code>vcov</code> matrix (the covariance matrix of the population parameters) and returns  a <code>FittedPumasModelInference</code> object used for inference based on the fitted model <code>fpm</code>. It gives the  95% confidence intervals and the relative standard errors for the parameter estimates</p><h2><a class="nav-anchor" id="The-inspect-Function-1" href="#The-inspect-Function-1">The <code>inspect</code> Function</a></h2><p><code>inspect(fpm::FittedPumasModel)</code></p><p><code>inspect</code> returns a <code>FittedPumasModelInspection</code> object with the model predictions, residuals and Empirical Bayes estimates.</p><h2><a class="nav-anchor" id="Model-Diagnostic-Functions-1" href="#Model-Diagnostic-Functions-1">Model Diagnostic Functions</a></h2><p>Model diagnostics are used to check if the model fits the data well. A number of residual diagnostics are available as well as shrinkage estimators.</p><h3><a class="nav-anchor" id="Population-Residuals-1" href="#Population-Residuals-1">Population Residuals</a></h3><p>Populations residuals take the inter-individual variability into account as opposed to individual residuals which are correlated due to the lack of accounting for inter-individual variability.</p><ul><li><code>npde(model, subject, param, randeffs, simulations_count)</code> : Normalized Prediction Distribution Errors</li></ul><p>The null hypothesis is that the validation data can be described by a given model. This null hypothesis can be tested with NPDEs by checking that they follow a standard normal distribution and that the NPDEs are uncorrelated.</p><p>The normalized prediction distribution error (NPDE), for subject <span>$i$</span> and observation <span>$j$</span>, is calculated as follows:</p><p>\begin{equation} npde<em>{ij} = \Phi^{-1}(pde</em>{ij}) \end{equation} where <span>$\Phi^{-1}$</span> is the inverse of the standard normal cumulative density function and the prediction distribution errors (<span>$pde_{ij}$</span>) are defined as: </p><p>\begin{equation} pde<em>{ij} = \frac{1}{N</em>{sim}}\sum<em>{n=1}^{N</em>{sim}}{\phi<em>{ijn}} \end{equation} where N</em>{sim}$ is the total number of simulated datasets and <span>$\phi_{ijn}$</span> is 1 if the <span>$n$</span> simulated decorrelated observation is below the actual decorrelated observation, i.e. <span>$y_{ij,decorr}^{n} &lt; y_{ij,decorr}$</span>, otherwise <span>$\phi_{ijn}$</span> is 0. The decorrelated observations and decorrelated simulated observations are calculated as:</p><p>\begin{equation} \label{eq:npde<em>decorr} y</em>{i,decorr} = \mathbf{V}[y<em>i]^{-1/2}(y</em>i-\mathbf{E}[y<em>i]) \end{equation} \begin{equation} \label{eq:npde</em>decorr<em>sim} y</em>{i,decorr}^n = \mathbf{V}[y<em>i]^{-1/2}(y</em>i^n-\mathbf{E}[y_i]) \end{equation}</p><p>where <span>$\mathbf{E}[y_i]$</span> and <span>$\mathbf{V}[y_i]$</span> are the empirical mean and variance of the data respectively. The empirical mean and variance are calculated as:</p><p>\begin{equation} \label{eq:npde<em>mean} \mathbf{E}[y</em>i] = \frac{1}{N<em>{sim}}\sum</em>{n=1}^{N<em>{sim}}y</em>i^n \end{equation} and </p><p>\begin{equation} \mathbf{V}[y<em>i] = \frac{1}{N</em>{sim}-1}\sum<em>{n=1}^{N</em>{sim}}(y<em>i^n-\mathbf{E}[y</em>i])(y<em>i^n-\mathbf{E}[y</em>i])^T \end{equation}</p><ul><li><code>wres(model, subject, param[, rfx])</code> : Weighted Residuals</li></ul><p>The simplest population weighted residuals are the WRES which are, for subject <span>$i$</span>, calculated as:</p><p>\begin{equation} \label{eq:wres} WRES<em>i = \mathbf{V}[y</em>i]^{-1/2}(y<em>i-\mathbf{E}[y</em>i]) \end{equation} where the variance is the FO variance, see \eqref{eq:fovar} and the mean is the FO mean, <span>$\mathbf{E}[y_i] = f_i(\theta,\eta_i^*=0,Z_i,t_i)$</span>. </p><ul><li><code>cwres(model, subject, param[, rfx])</code> : Conditional Weighted Residuals</li></ul><p>When the model starts to get non-linear with respect to the random effects the WRES might not be accurate enough. In such situations, other residuals based on linearization can be utilized. These residuals are conditioned on the EBEs and are therefore a better approximation of the true residuals. The CWRES, for subject <span>$i$</span>, are defined as:</p><p>\begin{equation} \label{eq:cwres} CWRES<em>i = \mathbf{V}[y</em>i]^{-1/2}(y<em>i-\mathbf{E}[y</em>i]) \end{equation} where the variance is the FOCE variance and the mean is the FOCE mean, <span>$\mathbf{E}[y_i] = f_i(...,\eta_i^* =\hat{\eta}_i^* )-F_i\hat{\eta}_i^{*T}$</span>. </p><ul><li><code>cwresi(model, subject, param[, rfx])</code> : Conditional Weighted Residuals with Interaction</li></ul><p>A further improvement of the CWRES residuals can be made when interaction in the residual error model is present. The CWRESI, for subject <span>$i$</span>, are defined as:</p><p>\begin{equation} \label{eq:cwresi} CWRESI<em>i = \mathbf{V}[y</em>i]^{-1/2}(y<em>i-\mathbf{E}[y</em>i]) \end{equation} where the variance is the FOCE variance but evaluated at <span>$\eta_i^* =\hat{\eta}_i^* $ instead of $\eta_i^* =0$</span>, see \eqref{eq:focevar} and the mean is the FOCE mean, <span>$\mathbf{E}[y_i] = f_i(...,\eta_i^* =\hat{\eta}_i^* )-F_i\hat{\eta}_i^{*T}$</span>.</p><h3><a class="nav-anchor" id="Individual-Residuals-1" href="#Individual-Residuals-1">Individual Residuals</a></h3><ul><li><code>iwres(model, subject, param[, rfx])</code> : Individual Weighted Residuals</li></ul><p>The individual weighted residual are similar as the WRES but without acknowledge the inter-individual variability, i.e. the individual weighted residuals for subject <span>$i$</span>, are defined as: \begin{equation}\label{eq:IWRES} IWRES<em>i=R</em>i^{-1/2}(y<em>i-f</em>i(\theta,\eta<em>i^*=0,Z</em>i,t<em>i)) \end{equation} where R</em>i$ is the residual variance for subject <span>$i$</span></p><ul><li><code>icwres(model, subject, param[, rfx])</code> : Individual Conditional Weighted Residuals</li></ul><p>As between the FO estimation method and FOCE estimation method, residuals can be evaluated at the EBEs or at 0. For the ICWRES, the model is evaluated at the estimated EBEs:  \begin{equation} \label{eq:ICWRES} ICWRES<em>i=R</em>i^{-1/2}(y<em>i-f</em>i(\theta,\eta<em>i^* =\hat{\eta}</em>i^<em>,Z<em>i,t</em>i)) \end{equation} where <span>$R_i$</span> is the residual variance for subject <span>$i$</span>, see \eqref{eq:res<em>var}. Note that the residual variance of ICWRES are evaluated at \eta</em>i^</em>=0$</p><ul><li><code>icwresi(model, subject, param[, rfx])</code> : Individual Conditional Weighted Residuals with Interaction</li></ul><p>The ICWRESI is very similar to the ICWRES, except that the residual variance is evaluated at the EBEs:</p><p>\begin{equation} \label{eq:ICWRESI} ICWRESI<em>i=R</em>i^{-1/2}(y<em>i-f</em>i(\theta,\eta<em>i^* =\hat{\eta}</em>i^<em>,Z<em>i,t</em>i)) \end{equation} where <span>$R_i$</span> is the residual variance for subject <span>$i$</span>, see \eqref{eq:res<em>var}. Note that the residual variance of ICWRESI are evaluated at \eta</em>i^</em> =\hat{\eta}_i^*$</p><ul><li><code>eiwres(model, subject, param[, rfx], simulations_count)</code> : Expected Simulation based Individual Weighted Residuals</li></ul><p>These residual are calculated similarly as the population residuals in the NPDE calculations but instead of decorrelating the population residuals, the expectation of the individual weighted residuals are taken with respect to the omega distribution, i.e.:</p><p>\begin{equation}  \label{eq:EIWRES} EIWRES<em>i=\frac{1}{N</em>{sim}}\sum<em>{k=1}^{N</em>{sim}}\mathbf{V}[y<em>i|\eta^k]^{-1/2}(y</em>i-\mathbf{E}[y_i|\eta^k]) \end{equation}</p><p>where <span>$\mathbf{E}[y_i|\eta^k]$</span> is the individual mean given <span>$\eta^k$</span> and <span>$\mathbf{V}[y_i|\eta^k]$</span> is the individual variance given <span>$\eta^k$</span>. </p><h3><a class="nav-anchor" id="Population-Predictions-1" href="#Population-Predictions-1">Population Predictions</a></h3><p>The populations residuals are defined as the difference between the observations and the model expectation for subject <span>$i$</span>, i.e. <span>$y_i-\mathbf{E}[y_i]$</span>, where the <span>$\mathbf{E}[y_i]$</span> are the population predictions. The population predictions, EPRED, PRED, CPRED and CPREDI  are defined as the <span>$\mathbf{E}[y_i]$</span> from equations of NPDE, WRES, CWRES and CWRESI respectively.</p><h3><a class="nav-anchor" id="Individual-Predictions-1" href="#Individual-Predictions-1">Individual Predictions</a></h3><p>The individual residuals are defined as the difference between the observations and the model prediction for subject <span>$i$</span>, i.e. <span>$y_i-f_i(\theta,\eta_i^* ,Z_i,t_i)$</span>, where the <span>$f_i(\theta,\eta_i^* ,Z_i,t_i)$</span> are the individual predictions. The individual predictions IPRED, CIPRED and CIPREDI are defined as the <span>$f_i(\theta,\eta_i^*,Z_i,t_i)$</span> from equations of IWRES, ICWRES and ICWRESI. The individual expected prediction (EIPRED) is defined as the individual mean conditioned on <span>$\eta_k$</span>, i.e. <span>$\mathbf{E}[y_i|\eta^k]$</span>, from equation of EIWRES.</p><h3><a class="nav-anchor" id="Model-Metrics-1" href="#Model-Metrics-1">Model Metrics</a></h3><ul><li><code>aic(model, population, param, approximation)</code> : Akaike information criterion</li><li><code>bic(model, population, param, approximation)</code> : Bayesian information criterion</li></ul><h3><a class="nav-anchor" id="Shrinkage-1" href="#Shrinkage-1">Shrinkage</a></h3><ul><li><code>ηshrinkage(model, population, param, approximation)</code></li><li><code>ϵshrinkage(model, population, param, approximation[, rfx])</code></li></ul><p>If the observations for an individual is informative, η-shrinkage will be low. If, on the other hand, the observations are non-informative, the individual estimates (EBEs) will shrink towards the population mean. Hence, the variance of the EBEs will also shrink and η-shrinkage will be high.</p><p>When data gets sparse the IWRES distribution also shrink towards it’s mean (zero). This is often called overfitting or ϵ-shrinkage.</p><h2><a class="nav-anchor" id="The-Visual-Predictive-Check-(vpc)-Function-1" href="#The-Visual-Predictive-Check-(vpc)-Function-1">The Visual Predictive Check (<code>vpc</code>) Function</a></h2><ul><li><code>vpc(m::PumasModel, data::Population, fixeffs::NamedTuple, reps::Integer;quantiles = [0.05,0.5,0.95], idv = :time, dv = [:dv], stratify_on = nothing)</code></li></ul><p>Computes the quantiles for VPC. The default quantiles are the 5th, 50th and 95th percentiles. Takes in a <code>PumasModel</code>, <code>Population</code>, parameters, and an integer number of repetitions.</p><p>The <code>vpc</code> function returns a <code>VPC</code> object which can then be used for plotting. </p><pre><code class="language-julia">vpc_nonstrat = vpc(m, data, param, 200)
plot(vpc_nonstrat)</code></pre><p>The <code>VPC</code> object stores the quantiles and the simulations which  can be used for recalculating the VPC quantiles with a different combination of arguments.</p><pre><code class="language-julia">vpc_stratwt = vpc(vpc_nonstrat.Simulations, data; stratify_on = [:wt])
plot(vpc_stratwt)</code></pre><p>Note that instead of the model a FittedPumasModel can be also be used.</p><p>Keyword arguments:</p><ul><li><code>quantiles</code>: Takes an array of quantiles to be calculated. The first three indices are used for plotting.</li><li><code>idv</code>: The idv to be used, defaults to time.</li><li><code>dv</code>: Takes an array of symbols of the dvs for which the quantiles are computed.</li><li><code>stratify_on</code>: Takes an array of symbols of covariates which the VPC is stratified on.</li></ul><footer><hr/><a class="previous" href="../../model_components/dynamical_types/"><span class="direction">Previous</span><span class="title">Dynamical Problem Types</span></a></footer></article></body></html>
